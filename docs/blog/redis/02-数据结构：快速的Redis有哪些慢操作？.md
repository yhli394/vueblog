---
toc: true
title: 02-数据结构：快速的Redis有哪些慢操作？
date: 2022-3-14
tags: [Redis核心技术与实战]
categories:
- Redis
---

Redis读写数据快的原因主要有两方面：其一：Redis是内存数据库；其二：Redis底层的数据结构。

Redis数据类型和底层数据结构的关系：其中String数据类型的底层是简单动态字符串，而其它四种数据类型的底层均有两种数据结构组成。

![快速的Redis有哪些慢操作-2022-03-14-19-55-14](https://imagecontainter-1309978559.cos.ap-chengdu.myqcloud.com/blogimages/快速的Redis有哪些慢操作-2022-03-14-19-55-14.png)

哈希表本质上是一个数组，每个数组中的元素称之为哈希桶，哈希桶中保存的不是元素的值本身，而是指向元素的指针。

哈希冲突：指的是多个键（两个或两个以上）经过哈希算法后，有着相同的索引值，即这些键被分配到了数组上的同一块区域。

Redis通过**链式哈希**来解决哈希冲突，具体指同一个哈希桶中的多个元素用一个链表来保存，它们之间依次用指针连接。

### rehash

1. 为什么要rehash?
虽然链式哈希可以解决哈希冲突，但是如果哈希冲突链表过长的话，会导致查找元素效率低下。因此，Redis需要对哈希表进行rehash操作。

2. rehash原理
增加现有的哈希桶数量，让逐渐增多的entry元素（键值对）能在更多的桶之间分散保存，减少单个桶中的冲突。
为了使得rehash操作高效，redis默认维护两张全局的哈希表。
执行rehash的过程：

- 给哈希表2分配更大的空间

- 把哈希表1中的数据重新映射并拷贝到哈希表2

- 释放哈希表1的空间

### 渐进式rehash

1. 为什么要渐进式rehash？
为了避免rehash的第二步，即将哈希表1中的数据拷贝到哈希表2中的时候，由于数据量过大而导致出现Redis线程阻塞，无法服务其它的请求。

2. 渐进式rehash原理
在rehash第二步的时候，Redis仍然正常处理客户端的请求，每当处理一个请求的时候，在哈希表1中索引为0的位置从左到右依次顺带拷贝数据到哈希表2中，巧妙的避开了一次性拷贝大量的数据。Redis本身也会有一个定时任务执行rehash，如果没有键值对操作，这个定时任务会周期性地搬移一些数据到哈希表2中。

### 压缩列表

和数组类似，压缩列表的表头有三个字段，分别为zlbytes、zltail、zllen，分别表示列表长度、列表尾的偏移量、列表中的entry个数（键值对个数），压缩列表表尾有一个zlend，表示列表结束。

### 跳表

跳表在链表的基础上，增加了多级索引，通过索引位置的几个跳转，实现数据的快速定位。

### Redis选择整数数组和压缩列表作为底层数据结构的原因

- 提高内存利用率：压缩列表和数组都是紧凑的数据结构，比链表占用内存更少。

- 数组对CPU高速缓存支持友好。
