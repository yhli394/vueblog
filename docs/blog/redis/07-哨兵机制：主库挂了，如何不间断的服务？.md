---
toc: true
title: 07-哨兵机制：主库挂了，如何不间断的服务？
date: 2022-4-18
tags: [Redis核心技术与实战]
categories:
- Redis
---

## 哨兵机制

在主从模式下，如果主库发生了故障，客户端有读的请求可以由从库继续提供服务，但是如果客户端发送的是写请求，此时主库发生了故障，就会导致写操作中断。为了避免发生这种情况，Redis引入了哨兵机制。哨兵机制是实现Redis服务不间断的重要保证。

哨兵机制是实现主从库自动切换的关键机制，哨兵是一个特殊的Redis进程，它主要负责三个任务：监控、选主（选择主库）、通知。

### 监控

主观下线：哨兵进程会使用Ping命令检测它自己和主、从库的网络连接情况，如果ping命令响应超时，那么哨兵暂时会把被检测的库标记为“主观下线”。

客观下线：单个哨兵对主库可能进行了误判（本来主库没故障，但是哨兵判断主库有故障），需要引入哨兵集群（多个哨兵实例）来进行判断，如果有超过一半以上的哨兵实例判断主库为“主观下线”，那么最终会判定主库“客观下线”。

### 选主

哨兵选择新主库会先进行“筛选”，然后进行“打分”，最后得分高者被选为新主库。

筛选：通过检测从库的当前和之前与主库的网络连接情况过滤掉一部分从库。

打分：一共有三轮打分，只要在某一轮中有从库得分最高，那么他就是主库。

- 第一轮：优先级最高的从库得分高（例如，可以手动的给内存大的从库设置优先级最高）。
- 第二轮：和旧主库同步程度最接近的从库得高分。
- 第三轮：优先级和复制进度相同的情况下，ID号（每一个实例都会有一个ID）小的从库得高分，会被选为新主库。

### 通知

哨兵将新主库的连接信息发给从库，让从库执行replicaof命令，与新主库进行同步。同时，哨兵会通知客户端，让它们把请求发在新主库上。

