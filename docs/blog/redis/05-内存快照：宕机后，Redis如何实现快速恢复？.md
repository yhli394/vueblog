---
toc: true
title: 05-内存快照：宕机后，Redis如何实现快速恢复？
date: 2022-3-27
tags: [Redis核心技术与实战]
categories:
- Redis
---

AOF持久化方案的不足：AOF日志记录的是操作的指令，如果AOF日志文件很大，Redis数据恢复的时候需要一条一条的读取指令，会导致恢复数据很慢。Redis的第二种持久化方案**内存快照**，可以加快数据的恢复。内存快照文件（RDB文件，Redis DataBase的缩写）记录的是内存中的数据在某一个时刻的状态。内存快照和拍照类似。

## 给那些内存数据做快照？

全量快照：将内存中的所有数据记录到磁盘中（Redis的默认行为）。

Redis提供了save和bgsave命令来生成RDB文件：

- save：在主线程中执行，会导致阻塞

- bgsave：创建一个子进程，专门用于写入RDB文件，避免了主线程的阻塞，这是Redis RDB文件生成的默认配置

## 快照时数据可以修改嘛？

为了保证数据的一致性，一般我们希望快照时数据不要动，类似于用手机给人照相时，不希望别人动来动去。

写时复刻技术（Copy-On-Write, COW）：操作系统提供给Redis使用的，使得Redis可以在执行快照的同时进行正常的写操作。简单来说，bgsave子进程是由主线程fork生成的，可以共享主线程的所有内存数据。bgsave子进程运行后，开始读取主线程的内存数据，并把他们写入RDB文件。

## 可以每秒做一次快照嘛？

不建议每秒做一次快照（和用手机在拍照时选择连拍类似），因为会带来两方面的开销：

- 频繁的将全量数据写入磁盘，会给磁盘带来很大的压力

- 从主线程fork子进程的过程会阻塞主线程

## 增量快照

增量快照指的是完成一次全量快照后，后续的快照只需要对修改的数据进行快照记录。但是这需要维护额外的信息表来记录修改的数据，带来了额外的空间开销。

## 混合使用AOF日志和内存快照

内存快照以一定的频率执行，在两次快照之间，使用AOF日志记录这期间的所有命令操作。当需要做第二次全量快照的时候，就可以清空AOF的日志，可以避免AOF日志重写带来的开销。
