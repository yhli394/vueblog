---
toc: true
title: 36-Redis支撑秒杀场景的关键技术和实践都有那些？
date: 2022-6-1
tags: [Redis核心技术与实战]
categories:
- Redis
---

## 秒杀活动（场景）的特征

- 瞬时的高并发访问量

Redis并发处理能力可以达到万级别，而MySQL数据库每秒只能支撑千级别的并发。因此，可以用Redis对大部分请求进行拦截，降低数据库的访问压力。

- 读（读：库存查询）多写（写：库存扣减和下单处理）少

秒杀活动库存有限，只有一些用户可以下单成功进而导致库存扣减（写），大量的用户做的是不断刷新页面，查询是否有库存（读）。

## 秒杀活动不同阶段分析

- 秒杀前（不需要使用Redis）
此阶段用户会不断刷新秒杀商品的显示页面，导致商品显示页请求量暴增。应对方案：把商品展示页的页面元素静态化，使用CDN或者浏览器将这些静态元素缓存起来，让秒杀前的大量请求走缓存，降低服务器的压力。

- 秒杀活动开始（需要使用Redis）
使用Redis进行库存查询和库存扣减，MySQL数据库进行订单处理。

下图显示了Redis在秒杀场景中参与的两个环节：

![Redis核心技术与实战-46-2022-06-01-16-26-48](https://images-1309978559.cos.ap-chengdu.myqcloud.com/blogimages/Redis核心技术与实战-46-2022-06-01-16-26-48.png)

为什么不使用MySQL数据库进行库存扣减？

1. 库存查询是在Redis中进行的，如果在数据库中进行了库存扣减，还需要和Redis进行库存量同步，**带来了额外的开销**。

2. 例如Redis中库存有100，当前有10个用户同时在查询库存，可能出现当第三个用户查询库存时，由于数据库处理速度较慢，Redis中的库存并没有及时更新，库存量依然是99，这**可能会出现实际订单量大于库存的情况**。

- 秒杀活动结束后（不需要使用Redis）
用户请求量骤降，少部分用户在等待其它用户退单。

## 秒杀活动对Redis的要求

- 支持高并发

- 保证库存查询和库存扣减操作的原子性

1. 在Redis中，可用通过**分布式锁**（具体做法：首先客户端向Redis申请分布式锁，只有拿到锁的客户端才能执行库存查询和库存扣减）保证客户端能够互斥的执行库存查询和库存扣减操作；

2. 也可以通过Lua脚本保证库存查询和库存扣减操作的原子性

## 设计秒杀系统的注意点

> 1.前端静态页面的设计。秒杀页面上能静态化处理的页面元素，我们都要尽量静态化，这样可以充分利用 CDN 或浏览器缓存服务秒杀开始前的请求。
> 2.请求拦截和流控。在秒杀系统的接入层，对恶意请求进行拦截，避免对系统的恶意攻击，例如使用黑名单禁止恶意 IP 进行访问。如果 Redis 实例的访问压力过大，为了避免实例崩溃，我们也需要在接入层进行限流，控制进入秒杀系统的请求数量。
> 3.库存信息过期时间处理。Redis 中保存的库存信息其实是数据库的缓存，为了避免缓存击穿问题，我们不要给库存信息设置过期时间。
> 4.数据库订单异常处理。如果数据库没能成功处理订单，可以增加订单重试功能，保证订单最终能被成功处理。
> 5.秒杀活动开始，尽量使用Redis（天然支持高并发）进行库存查询和库存扣减。
