---
toc: true
title: 09-切片集群：数据增多了，是该加内存还是加实例？
date: 2022-5-22
tags: [Redis核心技术与实战]
categories:
- Redis
---

## 切片集群

### 切片集群是什么？

切片集群，也叫做分片集群，指的是启动多个Redis实例组成一个集群，按照一定的规则，把收到的数据划分成多份，每一个实例保存一份数据。

### 为什么要使用切片集群？

在实际开发中，随着业务规模的扩大，保存大量数据的情况不可避免。Redis应对数据量增多有两种方案：纵向扩展和横向扩展。

- 纵向扩展：增加Redis实例所在的服务器配置（升级内存，硬盘容量等）。优点：实施起来简单，直接。缺点：成本较高；当使用RDB对数据进行持久化时，如果数据量增加，需要的内存也会增加，主线程fork子进程的时候可能会阻塞主线程，数据量越大，fork操作造成的主线程阻塞的时间越长，导致Redis响应变慢。

- 横向扩展：增加Redis实例个数（即切片集群）。优点：节约硬件成本

### 数据切片和实例的对应分布关系？

Redis 3.0开始官方提供了一个名为Redis Cluster的方案，用于实现切片集群。Redis Cluster方案采用哈希槽（Hash Slot）处理数据和实例之间的映射关系。具体来说：首先根据键值对的key，按照CRC16算法计算一个16bit的值，然后用这个16bit值对16384（Redis Cluster方案中，一个切片集群共有16384个哈希槽）取模，结果代表一个哈希槽的编号。如果使用cluster create命令创建集群，哈希槽会被均分到每个Redis实例上，当然也可以通过cluster addslots命令指定每个Redis实例上的哈希槽个数。

### 客户端怎么确定想要访问的数据在那个实例上？

Redis多个实例相互连接时会共享哈希槽的映射关系，当客户端和Redis集群建立连接时，客户端会拿到哈希槽信息并缓存在本地，当客户端请求键值对时会先计算键所对应的哈希槽，然后给对应的Redis实例发送请求。
