---
toc: true
title: 06-主从库如何实现数据一致性？
date: 2022-4-16
tags: [Redis核心技术与实战]
categories:
- Redis
---

Redis具有高可靠性有两层含义，一是数据尽量少丢失（由AOF和RDB保证）；二是服务尽量少中断（Redis提供主从库模式，将一份数据保存在多个实例上）。

## Redis主从库模式

读操作：主库和从库都可以

写操作：首先将数据写入主库，然后主库将数据同步给从库

### 为什么采用读写分离？

如果主从库都可以进行写操作，假设有一个数据A需要进行更新，每一次更新请求操作都发送到不同的库上去，如果要读取数据A,由于不同库上更新A后A的值可能不一样，这就导致了读取数据的不一致。

### 主从库间如何进行第一次同步的？

可以分为三个阶段：

- 第一阶段：建立连接，协商同步（FULLRESYNC响应表示第一次采用全量复制，即主库把所有数据复制给从库）
- 第二阶段：主库同步数据给从库（主库执行bgsave命令，生成RDB文件，从库接收到RDB文件，先清空数据库，然后加载RDB文件）
- 第三阶段：主库发送新写命令给从库（主库将同步过程中收到的记录在replication buffer中的新的写命令发送给从库）

### 如何分担主库的压力

通过“主-从-从”模式将主库生成RDB和传输RDB文件的压力，以级联的方式分散到从库上。

### 主从库间网络断了咋办？

Redis 2.8之前主从库会重新进行一次全量复制，开销很大。Redis 2.8之后主从库之间采用增量复制（主从库在网络断开期间，把主库收到的命令同步给从库）的方式继续同步
