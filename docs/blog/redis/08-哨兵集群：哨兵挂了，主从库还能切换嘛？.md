---
toc: true
title: 08-哨兵集群：哨兵挂了，主从库还能切换嘛？
date: 2022-4-18
tags: [Redis核心技术与实战]
categories:
- Redis
---
如果多个实例组成哨兵集群，即使有哨兵实例出现故障挂掉了，其他哨兵还能继续协作完成主从库的切换工作（包括判定主库是不是处于下线状态、先择新主库、通知从库和客户端）。

## 基于pub/sub机制的哨兵集群组成
### 哨兵不知道彼此的地址，又是如何组成集群的呢？
Redis提供了pub（发布）/sub（订阅）机制，订阅了同一个频道（消息类别相同）的应用，才能通过发布的消息进行消息交换。现在假设主从集群上，主库有一个“hello”的频道，哨兵1将自己的ip和端口发布到“hello”频道上，然后哨兵2和3订阅了“hello”频道。哨兵2和3就可以通过该频道获取哨兵1的IP和端口号，进而彼此之间可以相互通信。

### 哨兵如何知道从库的IP和端口号？
哨兵通过向主库发送INFO命令，主库会返回一个Slave列表给哨兵，哨兵通过列表中从库的信息就可以和从库建立通信。

## 基于pub/sub机制的客户端通知事件
本质上说，哨兵就是一个运行在特定模式下的Redis实例，只不过它并不服务请求操作，只是完成监控、选主以及通知。每个哨兵实例也提供pub/sub机制，允许客户端订阅。
```redis
PSUBSCRIBE  *
```
客户端执行上面的命令就可以订阅哨兵的所有事件
## 由哪个哨兵执行主从切换？
哨兵集群在判断主库客观下线后，经过投票仲裁，选举出一个Leader出来，由它负责实际的主从切换，即由它完成新主库的选择以及通知从库与客户端。
