---
toc: true
title: 04-AOF日志：宕机了，Redis如何避免数据丢失？
date: 2022-3-20
tags: [Redis核心技术与实战]
categories:
- Redis
---

Redis持久化的两大机制，AOF（Append Only File，表示文件只能追加写）日志和RDB快照。为什么要进行持久化呢？主要是避免服务器宕机，内存数据丢失，然后从数据库进行数据恢复，从而给数据库带来巨大的访问压力。

## AOF日志

与数据库的WAL技术（写前日志：先写日志，再写磁盘）不同，AOF是写后日志，即：Redis先执行命令，把数据写入内存，然后才记录日志。AOF中记录的是Redis收到的每一条指令，例如"set testkey testvalue"指令在AOF文件中的记录形式为（*3 $3 set $7 testkey $9 testvalue）。

### AOF的优点

1. 由于是写后日志（写日志前，系统会对命令做分析，如果命令有误，会直接向客户端报错），因此避免了日志中记录的命令有错。

2. 命令执行后才记录日志，所以不会阻塞当前的写操作。

### AOF的潜在风险

1. **数据丢失**：如果刚执行完一个命令，还未及时的写到AOF中就宕机了，可能导致这个命令和相应的数据有丢失的风险。

2. **阻塞下一个操作**：AOF日志也是在主线程中执行，如果AOF日志在写回磁盘时，速度很慢，可能会阻塞下一个操作。

### 如何规避AOF带来的风险

AOF配置项appendfsync有三个可选值：

1. 同步写回（Always）：每个写命令执行完后，马上同步地将日志写回磁盘；

2. 每秒写回（Everysec）：每个写命令执行完后，先把日志写到AOF文件的内存缓冲区，每隔一秒把缓冲区的内容写入磁盘；

3. 操作系统控制的写回（No）：每个写命令执行完后，先把日志写到AOF文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘；

### AOF重写机制

为什么需要AOF重写机制？

- 避免AOF日志文件过大，以后再往里面追加命令效率会变低。

- 避免宕机后，数据恢复速度过慢。

- 避免文件系统对文件大小有限制，无法保存过大的文件。

AOF重写机制的原理

AOF重写时，Redis会把主线程的内存拷贝一份给子进程，子进程在后台完成AOF日志的重写，具体来说会先从数据库中读取键现有的值，然后用一条命令去记录键值对，代替旧AOF文件中记录这个键值对的多条命令。

Q：AOF重写会阻塞吗？

A：不会，Redis采用额外的线程进行数据重写，因此不会阻塞主线程。

Q：AOF重写为什么不复用AOF本身的日志？

A：如果AOF重写失败了，那么原本AOF文件相当于被污染了，给数据恢复带来了困难。
