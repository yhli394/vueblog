---
toc: true
title: 08-事务到底是隔离的还是不隔离的？
date: 2022-4-11
tags: [MySQL实战45讲]
categories:
 - MySQL
---

在MySQL中，有两个“视图”的概念，分别是view和consistent read view。

- view：是一张虚拟的表，将查询结果封装在一张虚拟表中，下次查询相同的数据时不必写一长串sql语句，直接从虚拟表中就可以查询出相同的数据。一般应该将视图用于查询（select），而不是用于更新（update,delete,insert）。创建视图的例句如下：
  
```sql
CREATE VIEW viewname AS select .....  from .... where ....
```

- consistent read view（一致性视图）：InnoDB在实现MVCC时用到的一致性视图，用于支持RC(Read Committed，读提交)和RR(Repeatable Read，可重复读)隔离级别的实现。

## 快照在MVCC里是怎么工作的？

可重复读隔离级别下，事务在启动的时候基于整个数据库拍了一个快照。每个事务在创建的时候都会向事务系统申请一个唯一的事务ID，且按照申请顺序严格递增进行的。数据库中表的每一行可能会有多个版本，每个版本的ID就是对当前行进行处理的事务的ID。

InnoDB利用了所有数据都有多个版本的特性，实现了秒级创建快照的能力。

### 数据版本可见性规则

事务在启动的瞬间，InnoDB会为每个事务创建一个视图数组，数组里面存放的是启动了，但还没提交的事务的ID。数组中ID的最小值记为**低水位**，当前系统中已经创建过的事务ID的最大值加1记为**高水位**。

一个数据版本，对于一个视图来说，除了自己的更新总是可见以外，有三种情况：

1. 版本未提交，不可见

2. 版本已提交，但是是在视图创建后提交的，不可见

3. 版本已提交，而且是在视图创建前提交的，可见

## 更新逻辑

更新数据都是先读后写，这个读只能读当前的值，称之为“当前读”。

可重复读的核心是一致性读（consistent read）；事务更新数据的时候，只能用当前读。如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。

读提交和可重复读的主要区别：

- 在可重复读隔离级别下，只需要在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图

- 读提交隔离级别下，每一个语句执行前都会重新算出一个新的视图

## 总结

MySQL中读取数据的时候是一致性读（事务开始前会创建一个一致性视图，事务在执行过程中，所有其他未提交或已经提交的事务，对当前的事务不可见），更新数据的时候是当前读（基于最新的数据来进行更新）。
