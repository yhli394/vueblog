---
toc: true
title: 13-为什么表数据删掉一半，表文件大小不变？
date: 2022-5-28
tags: [MySQL实战45讲]
categories:
 - MySQL
---

## 参数innodb_file_per_table

> 一个InnoDB表包含两部分：表结构定义和数据。表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是由参数 innodb_file_per_table 控制的，默认值为ON（表示每一个InnoDB表数据存储在一个以.ibd为后缀的文件中，你不需要这个表的时候，通过 drop table 命令，系统就会直接删除这个文件。而如果是放在共享表空间中，即使表删掉了，空间也是不会回收的。）。

## 空洞

> 要删除表中的某些行，InnoDB存储引擎会把这些要删除的行标记为可复用，磁盘文件的大小不会变小；InnoDB 的数据是按页存储的，如果我们删掉了一个数据页上的所有记录，那么这个数据页会被标记为可复用，同时磁盘文件的大小也不会变小。这些可以复用，而没有被使用的空间，看起来就像是“空洞”。

> 不止是删除数据会造成空洞，插入数据也会。如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂。页分裂完成后，在原数据页末尾会留下空洞


## 如何去掉空洞，收缩表空间？

重建表可以达到这个目的。

> 试想一下，如果你现在有一个表 A，需要做空间收缩，为了把表中存在的空洞去掉，你可以怎么做呢？你可以新建一个与表 A 结构相同的表 B，然后按照主键 ID 递增的顺序，把数据一行一行地从表 A 里读出来再插入到表 B 中。由于表 B 是新建的表，所以表 A 主键索引上的空洞，在表 B 中就都不存在了。显然地，表 B 的主键索引更紧凑，数据页的利用率也更高。如果我们把表 B 作为临时表，数据从表 A 导入表 B 的操作完成后，用表 B 替换 A，从效果上看，就起到了收缩表 A 空间的作用。