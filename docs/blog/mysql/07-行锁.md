---
toc: true
title: 07-行锁
date: 2022-3-31
tags: [MySQL实战45讲]
categories:
 - MySQL
---

行锁，就是对数据库中的表的行加锁，例如事务A和事务B同时更新一行，事务A先拿到行锁，那么事务B需要等待事务A操作完成以后才能进行更新操作，避免数据不一致。
MySQL的行锁是在引擎层由各个引擎自己实现的。MyISAM引擎不支持行锁，而InnoDB引擎支持行锁。

## 两阶段锁

- 两阶段锁协议
在InnoDB事务中，行锁是在需要的时候才加上的，并不是不需要了就立刻释放，而是要等到事务结束时才释放。

如果事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放，以减少事务之间的锁等待，提升并发度。

## 死锁

- 什么是死锁？
并发系统中不同的线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源，会导致这几个线程都进入无限等待的状态，这称为死锁。

- 怎样解决死锁？

1. 设置一个超时时间T，被锁住的线程等待时间超过T后退出。

2. 发起死锁检测，当发生死锁之后，主动回滚死锁链条中的一个事务，让其它事务可以继续执行。

- 如何解决热点行更新导致死锁检测需要耗费大量的CPU资源？

思路一：如果可以确保这个业务一定不会出现死锁，可以临时把死锁检测关掉。
思路二：控制并发度，即控制访问相同资源的并发事务量。
