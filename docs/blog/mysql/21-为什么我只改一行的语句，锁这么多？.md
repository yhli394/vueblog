---
toc: true
title: 21-为什么我只改一行的语句，锁这么多？
date: 2022-6-22
tags: [MySQL实战45讲]
categories:
 - MySQL
---

作者总结了一套加锁规则（这个规则只限于截止到现在的最新版本，即 5.x 系列 <=5.7.24，8.0 系列 <=8.0.13），即两个“原则”、两个“优化”和一个“bug”。

> 原则 1：加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。
> 原则 2：查找过程中访问到的对象才会加锁。
> 优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。
> 优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。
> 一个 bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。

- 可重复读隔离级别遵守两阶段锁协议，所有加锁的资源，都是在事务提交或者回滚的时候才释放的。

- 读提交隔离级别下，锁的范围更小，锁的时间更短，这也是不少业务都默认使用读提交隔离级别的原因。

