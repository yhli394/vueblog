---
toc: true
title: java内存区域与内存溢出
date: 2022-6-19
tags: [《深入理解Java虚拟机》- 第三版]
categories:
- JVM
---

## 内存区域划分

Java虚拟机所划分的内存区域包括：程序计数器，虚拟机栈，本地方法栈，堆，方法区

### 程序计数器（Program Counter Register）

程序计数器是一块较小的内存空间，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。程序计数器的特点包括：“线程私有”的内存区域；唯一一个在《Java虚拟机规范》中没有规定任何OutOfMemoryError情况的区域。

### 虚拟机栈（Virtual Machine Stack）

虚拟机栈描述的是Java方法执行的线程内存模型：每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧（Stack Frame，一种数据结构）用于存储局部变量表、操作数栈以及动态连接等信息。虚拟机栈是“线程私有”的内存区域。

### 本地方法栈（Native Method Stacks）

和虚拟机栈作用类似，区别在于虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈是为虚拟机使用到的本地（Native）方法服务。Note: HotSpot虚拟机将本地方法栈和虚拟机栈合二为一。本地方法栈是“线程私有”的内存区域。

### 堆（Heap）

堆的作用是为对象实例以及数组分配内存。堆是虚拟机所管理的内存中最大的一块，是“线程共享”的内存区域。

### 方法区（Method Area）

方法区作用是存储已被虚拟机加载的类型信息、常量、静态变量等数据，是“线程共享”的内存区域。

方法区和永久代的区别：

> 《Java 虚拟机规范》只是规定了有方法区这么个概念和它的作用，并没有规定如何去实现它。那么，在不同的 JVM 上方法区的实现肯定是不同的了。 方法区和永久代的关系很像 Java 中接口和类的关系，类实现了接口，而永久代就是 HotSpot 虚拟机对虚拟机规范中方法区的一种实现方式。 也就是说，永久代是 HotSpot 的概念，方法区是 Java 虚拟机规范中的定义，是一种规范，而永久代是一种实现，一个是标准一个是实现，其他的虚拟机实现并没有永久代这一说法。

java 8 新特性为什么移除永久代而引入元空间？

①永久代更容易导致OOM（OutOfMemoryError异常）
永久代有大小限制，不像元空间使用的是本地内存
②极少数方法（例如，String类中的intern()方法）会因为永久代的原因而导致在不同虚拟机中有不同的表现

## HotSpot虚拟机对象探秘

### 对象的创建

HotSpot中普通java对象（不包括数组和Class对象等）创建的主要流程：Java虚拟机遇到new 字节码指令→检查指令的参数是否能在常量池中定位到一个类的符号引用，并且检查类是否被加载，解析和初始化，如果没有必须先执行类加载→类加载通过后为对象分配内存空间→内存分配完成后，虚拟机将分配到的内存空间（不包括对象头）都初始化为零值→设置对象头→执行Class文件中的init()方法

### 对象的内存布局

在HotSpot中对象在对堆内存中的存储布局可以划分为三个部分：对象头、实例数据以及对齐填充。

对象头由两部分信息组成，第一部分：用于存储对象自身的运行时数据，例如哈希码、GC分代年龄等；第二部分：类型指针。

实例数据：对象真正存储的有效信息，例如字段信息等。

对齐填充：起着占位符的作用，由于HotSpot虚拟机规定任何对象的大小都必须是8字节的整数倍，对象头的大小已经是8字节的倍数，如果实例数据部分没有对其（大小不是8字节的倍数）的话，就由对齐填充来充当占位符，使得实例数据部分的大小为8字节的倍数。

### 对象的访问定位

Java程序会通过栈上的reference数据来操作堆上的具体对象，目前主流的访问方式有使用句柄和直接指针两种。

