---
toc: true
title: 03-Java虚拟机是如何加载Java类的
date: 2022-1-14
tags: [《深入拆解Java虚拟机》]
categories:
- JVM
---

#### 前言

- java语言分为基本类型(primitive types)和引用类型(reference types)

| 基本类型 | 引用类型 |
| :------: | :------: |
|   byte   |    类    |
|  short   |   接口   |
|   int    |  数组类  |
|   long   | 泛型参数 |
|  float   |    -     |
|  double  |    -     |
|   char   |    -     |
| boolean  |    -     |

<!--more-->

#### 加载

- 加载：指的是查找字节流、并且据此创建类的过程
- 数组类没有对应的字节流，而是由java虚拟机直接生成
- 双亲委派模型：当一个类加载器接收到加载请求时，它会先将请求转发给父类加载器。在父类加载器没有找到所请求的类的情况下，该类加载器才会尝试去加载
- 扩展类加载器（extension class loader）的父类加载器是启动类加载器
- 应用类加载器（application class loader）的父类加载器是扩展类加载器

- Java 9 引入了模块系统，将扩展类加载器改名为平台类加载器(platform class loader)

- 同一串字节流经由不同的类加载器会得到两个不同的类

#### 链接

- 链接：将创建成的类合并至Java虚拟机中，使之能够执行的过程。链接分为验证、准备、解析三个阶段
- 验证阶段：确保被加载的类能够满足Java虚拟机的约束条件
- 准备阶段：为被加载类的静态字段分配内存
- 解析阶段：由于class文件加载到Java虚拟机之前不知道自己的成员（方法和字段）和其他类的成员的地址，需要引用的时候，Java编译器会生成一个符号引用，解析阶段的目的就是将这些符号引用解析成为实际引用，如果符号引用指向一个未被加载的类及其成员，那么解析将会触发这个类的加载（未必触发这个类的链接以及初始化）

#### 初始化

- 初始化：为标记为常量值的字段赋值，以及执行**<clinit>**方法（对静态变量和静态代码块进行初始化）的过程

- 如果直接赋值的静态字段被final修饰，且它的类型是基本类型或字符串时，那么该字段便会被java编译器标记为常量值（ConstantValue），其初始化直接由java虚拟机完成。除此之外的直接赋值操作，以及所有静态代码块中的代码，会被Java编译器置于同一方法中，并把它命名为<clinit>

- Java虚拟机会通过加锁来确保类的<clinit>方法仅被执行一次

- 类初始化是线程安全的，且仅被执行一次，这个特性被用来实现单例的延迟初始化







